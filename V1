<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Deployment Tool</title>
    <!-- Importing Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
        }
        textarea {
            font-family: monospace;
            height: 150px;
        }
        .table-cell {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .table-header {
            padding: 10px 12px;
            border-bottom: 2px solid #cbd5e1;
            background-color: #f8fafc;
            font-weight: 600;
        }
        .app-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        .conflict-item {
            border-left: 4px solid #ef4444;
            padding: 8px 12px;
            background-color: #fee2e2;
            color: #991b1b;
        }
        .warning-item {
             border-left: 4px solid #f59e0b;
            padding: 8px 12px;
            background-color: #fef3c7;
            color: #92400e;
        }
        .validation-error {
            color: #dc2626;
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            padding: 10px;
            border-radius: 6px;
        }
        .validation-success {
            color: #166534;
            background-color: #dcfce7;
            border: 1px solid #86efac;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Advanced Teacher Deployment Tool</h1>

        <!-- Section 1: Data Input -->
        <div class="app-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 1: Paste Your Data</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Teacher Input -->
                <div>
                    <label for="teacherData" class="block text-sm font-medium text-gray-700 mb-2">Teacher List (CSV Format)</label>
                    <textarea id="teacherData" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="TeacherName,Subject,Restrictions
Mr. Harrison,Mathematics,DAY_NOT:Friday
Ms. Alvers,Physics,START_AFTER:10:00
Mr. Cho,English,LEVEL_ONLY:3
Mrs. Devi,Chemistry,MAX_CLASSES:5
Dr. Blevins,History,DAY_NOT:Friday;LEVEL_ONLY:4"></textarea>
                </div>
                <!-- Class Schedule Input -->
                <div>
                    <label for="classData" class="block text-sm font-medium text-gray-700 mb-2">Class Schedule (CSV Format)</label>
                    <textarea id="classData" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ClassID,ClassName,Subject,Day,TimeSlot
C101,1-1,Mathematics,Monday,09:00-10:00
C102,1-2,Mathematics,Monday,10:00-11:00
C103,3-1,Physics,Monday,09:00-10:00
C104,4-5,English,Friday,11:00-12:00"></textarea>
                </div>
            </div>
            <button id="processButton" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Validate & Process Data
            </button>
            <div id="validation-status" class="mt-4"></div>
        </div>

        <!-- Section 2: Deployment & Conflicts -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Master Deployment List -->
            <div class="app-section lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 2: Assign Teachers</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="master-table-head">
                            <!-- Headers will be injected by JS -->
                        </thead>
                        <tbody id="master-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td class="p-4 text-center text-gray-500" colspan="6">Validate and process data to see deployment list.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Conflicts List -->
            <div class="app-section lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Conflicts & Warnings</h2>
                <div id="conflicts-list" class="space-y-3">
                    <p class="text-gray-500">No conflicts detected.</p>
                </div>
            </div>
        </div>

        <!-- Section 3: Individual View -->
        <div class="app-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 3: View Individual Timetables</h2>
            <div class="flex items-center space-x-4">
                <label for="teacherSelect" class="text-sm font-medium text-gray-700">Select Teacher:</label>
                <select id="teacherSelect" class="block w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Select a Teacher --</option>
                </select>
            </div>
            <div class="overflow-x-auto mt-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead id="individual-table-head">
                        <!-- Headers will be injected by JS -->
                    </thead>
                    <tbody id="individual-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td class="p-4 text-center text-gray-500" colspan="5">Select a teacher to see their schedule.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        // Global data stores
        let teachers = [];
        let classes = [];
        let assignments = {}; // key: ClassID, value: TeacherName
        let teacherOptionsHTML = '<option value="Unassigned">-- Unassigned --</option>';

        // DOM elements
        const processButton = document.getElementById('processButton');
        const teacherDataEl = document.getElementById('teacherData');
        const classDataEl = document.getElementById('classData');
        const validationStatusEl = document.getElementById('validation-status');
        const masterTableHead = document.getElementById('master-table-head');
        const masterTableBody = document.getElementById('master-table-body');
        const conflictsList = document.getElementById('conflicts-list');
        const teacherSelect = document.getElementById('teacherSelect');
        const individualTableHead = document.getElementById('individual-table-head');
        const individualTableBody = document.getElementById('individual-table-body');

        // Event Listeners
        processButton.addEventListener('click', processAllData);
        teacherSelect.addEventListener('change', showIndividualSchedule);

        /**
         * Parses CSV text into an array of objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return []; 
            
            const headers = lines.shift().split(',').map(h => h.trim());
            
            return lines.map(line => {
                // Split by comma, but handle potential commas inside restrictions (though current syntax avoids this)
                const values = line.split(',').map(v => v.trim());
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || ""; // Handle empty fields
                });
                return obj;
            });
        }

        /**
         * Validates the parsed teacher and class data.
         */
        function validateData() {
            let errors = [];
            let teacherNames = new Set();
            let classIDs = new Set();
            // Regex for class names: 1-1 to 4-8, and 5-1
            const classNameRegex = /^[1-4]-[1-8]$|^5-1$/;

            teachers.forEach((t, index) => {
                if (!t.TeacherName) {
                    errors.push(`Teacher List (Row ${index + 1}): Missing TeacherName.`);
                } else if (teacherNames.has(t.TeacherName)) {
                    errors.push(`Teacher List: Duplicate TeacherName found: "${t.TeacherName}".`);
                }
                teacherNames.add(t.TeacherName);
            });

            classes.forEach((c, index) => {
                if (!c.ClassID) {
                    errors.push(`Class Schedule (Row ${index + 1}): Missing ClassID.`);
                } else if (classIDs.has(c.ClassID)) {
                    errors.push(`Class Schedule: Duplicate ClassID found: "${c.ClassID}".`);
                }
                classIDs.add(c.ClassID);

                if (!c.ClassName) {
                    errors.push(`Class Schedule (Row ${index + 1}): Missing ClassName.`);
                } else if (!classNameRegex.test(c.ClassName)) {
                    errors.push(`Class Schedule (Row ${index + 1}): Invalid ClassName format: "${c.ClassName}". Must be "1-1" to "4-8" or "5-1".`);
                }

                if (!c.Day || !c.TimeSlot) {
                     errors.push(`Class Schedule (Row ${index + 1}): Missing Day or TimeSlot.`);
                }
            });

            if (errors.length > 0) {
                validationStatusEl.className = 'validation-error';
                validationStatusEl.innerHTML = `<strong>Data Validation Failed:</strong><ul class="list-disc pl-5 mt-2">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
                return false;
            }

            validationStatusEl.className = 'validation-success';
            validationStatusEl.innerHTML = `<strong>Data Validated Successfully.</strong> ${teachers.length} teachers and ${classes.length} classes loaded.`;
            return true;
        }

        /**
         * Main function to process both text areas and build the UI.
         */
        function processAllData() {
            // 1. Clear all UI
            masterTableBody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="6">Validate and process data to see deployment list.</td></tr>`;
            conflictsList.innerHTML = '<p class="text-gray-500">No conflicts detected.</p>';
            individualTableBody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="5">Select a teacher to see their schedule.</td></tr>`;
            
            // 2. Process Teachers & Classes
            try {
                teachers = parseCSV(teacherDataEl.value);
                classes = parseCSV(classDataEl.value);
            } catch (e) {
                validationStatusEl.className = 'validation-error';
                validationStatusEl.innerHTML = `<strong>Error parsing data.</strong> Please check CSV format. ${e.message}`;
                return;
            }
            
            // 3. Validate Data
            if (!validateData()) {
                return; // Stop if validation fails
            }

            // 4. Reset assignments
            assignments = {};
            classes.forEach(c => {
                assignments[c.ClassID] = "Unassigned";
            });

            // 5. Build UI components
            buildTeacherOptions();
            populateMasterTable();
            populateTeacherSelect();
            runConflictCheck();
            showIndividualSchedule(); // Clear individual table
        }

        /**
         * Builds the HTML string for teacher <option> elements.
         */
        function buildTeacherOptions() {
            teacherOptionsHTML = '<option value="Unassigned">-- Unassigned --</option>';
            teachers.forEach(teacher => {
                teacherOptionsHTML += `<option value="${teacher.TeacherName}">${teacher.TeacherName} (${teacher.Subject})</option>`;
            });
        }

        /**
         * Populates the main assignment table (Master Deployment List).
         */
        function populateMasterTable() {
            masterTableHead.innerHTML = `
                <tr>
                    <th class="table-header text-left">Class Name</th>
                    <th class="table-header text-left">Subject</th>
                    <th class="table-header text-left">Day</th>
                    <th class="table-header text-left">Time</th>
                    <th class="table-header text-left">Assign Teacher</th>
                    <th class="table-header text-left">Status</th>
                </tr>
            `;
            masterTableBody.innerHTML = ''; // Clear existing

            classes.forEach(cls => {
                const row = document.createElement('tr');
                row.id = `row-${cls.ClassID}`;
                const assignedTeacher = assignments[cls.ClassID] || "Unassigned";

                row.innerHTML = `
                    <td class="table-cell">${cls.ClassName} (${cls.ClassID})</td>
                    <td class="table-cell">${cls.Subject}</td>
                    <td class="table-cell">${cls.Day}</td>
                    <td class="table-cell">${cls.TimeSlot}</td>
                    <td class="table-cell">
                        <select class="w-full p-1 border border-gray-300 rounded-md" data-class-id="${cls.ClassID}" onchange="assignTeacher(event)">
                            ${teacherOptionsHTML}
                        </select>
                    </td>
                    <td class="table-cell">
                        <span id="status-${cls.ClassID}" class="text-gray-500">Unassigned</span>
                    </td>
                `;
                masterTableBody.appendChild(row);
                row.querySelector('select').value = assignedTeacher;
            });
        }

        /**
         * Populates the "Individual View" dropdown.
         */
        function populateTeacherSelect() {
            teacherSelect.innerHTML = '<option value="">-- Select a Teacher --</option>';
            teachers.forEach(teacher => {
                teacherSelect.innerHTML += `<option value="${teacher.TeacherName}">${teacher.TeacherName}</option>`;
            });
        }

        /**
         * Handles the 'onchange' event from a teacher assignment dropdown.
         */
        function assignTeacher(event) {
            const teacherName = event.target.value;
            const classID = event.target.dataset.classId;
            assignments[classID] = teacherName;
            
            const statusEl = document.getElementById(`status-${classID}`);
            if (teacherName === "Unassigned") {
                statusEl.textContent = "Unassigned";
                statusEl.className = "text-gray-500";
            } else {
                statusEl.textContent = "Assigned";
                statusEl.className = "text-green-600 font-medium";
            }

            runConflictCheck();
            showIndividualSchedule(); // Update individual view
        }

        /**
         * Parses a restriction string (e.g., "DAY_NOT:Friday;LEVEL_ONLY:2")
         * into an array of rule objects.
         */
        function parseRestrictions(restrictionsText) {
            if (!restrictionsText) return [];
            return restrictionsText.split(';').map(ruleStr => {
                const parts = ruleStr.split(':');
                if (parts.length !== 2) return null;
                return { type: parts[0].trim().toUpperCase(), value: parts[1].trim() };
            }).filter(Boolean); // Filter out any null/invalid rules
        }

        /**
         * Checks all assignments for conflicts.
         */
        function runConflictCheck() {
            conflictsList.innerHTML = '';
            let conflictsFound = 0;
            const scheduleLog = {}; // For double booking
            const teacherAssignmentCounts = {};
            teachers.forEach(t => teacherAssignmentCounts[t.TeacherName] = 0);
            
            // Pre-count all assignments for MAX_CLASSES check
            Object.values(assignments).forEach(teacherName => {
                if (teacherName !== "Unassigned") {
                    teacherAssignmentCounts[teacherName]++;
                }
            });

            classes.forEach(cls => {
                const teacherName = assignments[cls.ClassID];
                if (teacherName === "Unassigned") return;

                const teacher = teachers.find(t => t.TeacherName === teacherName);
                if (!teacher) return; 

                const rules = parseRestrictions(teacher.Restrictions);
                const classTime = `${cls.Day}@${cls.TimeSlot}`;
                const classLevel = cls.ClassName.split('-')[0];
                const classStartTime = cls.TimeSlot.split('-')[0];

                // 1. Double Booking Check
                const bookingKey = `${teacherName}-${classTime}`;
                if (scheduleLog[bookingKey]) {
                    conflictsFound++;
                    addConflict(`<b>Double Booking:</b> ${teacherName} is assigned to ${cls.ClassName} and ${scheduleLog[bookingKey]} at the same time (${classTime}).`);
                } else {
                    scheduleLog[bookingKey] = cls.ClassName;
                }
                
                // 2. Subject Mismatch Check (Warning)
                if (teacher.Subject !== cls.Subject) {
                    conflictsFound++;
                    addConflict(`<b>Subject Mismatch:</b> ${teacherName} (${teacher.Subject}) assigned to ${cls.ClassName} (${cls.Subject}).`, 'warning');
                }

                // 3. Advanced Restriction Checks
                rules.forEach(rule => {
                    switch(rule.type) {
                        case 'DAY_NOT':
                            if (rule.value.toLowerCase() === cls.Day.toLowerCase()) {
                                conflictsFound++;
                                addConflict(`<b>Restriction:</b> ${teacherName} is not available on ${rule.value} (assigned to ${cls.ClassName}).`);
                            }
                            break;
                        case 'START_AFTER':
                            // Simple string comparison works for HH:MM format
                            if (classStartTime < rule.value) { 
                                conflictsFound++;
                                addConflict(`<b>Restriction:</b> ${teacherName} must start after ${rule.value} (assigned to ${cls.ClassName} at ${classStartTime}).`);
                            }
                            break;
                        case 'LEVEL_ONLY':
                            if (classLevel !== rule.value) {
                                conflictsFound++;
                                addConflict(`<b>Restriction:</b> ${teacherName} can only teach Level ${rule.value} (assigned to ${cls.ClassName}).`);
                            }
                            break;
                        case 'CLASS_ONLY':
                            if (cls.ClassName !== rule.value) {
                                conflictsFound++;
                                addConflict(`<b>Restriction:</b> ${teacherName} can only teach ${rule.value} (assigned to ${cls.ClassName}).`);
                            }
                            break;
                    }
                });
            });
            
            // 4. MAX_CLASSES Check (done after all other checks)
            teachers.forEach(teacher => {
                const rules = parseRestrictions(teacher.Restrictions);
                const maxClassesRule = rules.find(r => r.type === 'MAX_CLASSES');
                if (maxClassesRule) {
                    const assignedCount = teacherAssignmentCounts[teacher.TeacherName];
                    if (assignedCount > parseInt(maxClassesRule.value)) {
                         conflictsFound++;
                         addConflict(`<b>Restriction:</b> ${teacher.TeacherName} is over max classes (assigned ${assignedCount}, max ${maxClassesRule.value}).`);
                    }
                }
            });

            if (conflictsFound === 0) {
                conflictsList.innerHTML = '<p class="text-green-600">No conflicts detected.</p>';
            }
        }

        /**
         * Helper to add a conflict message to the UI.
         */
        function addConflict(message, type = 'error') {
            const item = document.createElement('div');
            item.innerHTML = message;
            item.className = (type === 'error') ? 'conflict-item' : 'warning-item';
            conflictsList.appendChild(item);
        }

        /**
         * Displays the selected teacher's schedule.
         */
        function showIndividualSchedule() {
            const selectedTeacher = teacherSelect.value;
            
            individualTableHead.innerHTML = `
                <tr>
                    <th class="table-header text-left">Day</th>
                    <th class="table-header text-left">Time</th>
                    <th class="table-header text-left">Class Name</th>
                    <th class="table-header text-left">Subject</th>
                    <th class="table-header text-left">ClassID</th>
                </tr>
            `;
            individualTableBody.innerHTML = '';
            
            if (!selectedTeacher) {
                individualTableBody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="5">Select a teacher to see their schedule.</td></tr>`;
                return;
            }

            const teacherClasses = classes.filter(cls => assignments[cls.ClassID] === selectedTeacher);

            if (teacherClasses.length === 0) {
                individualTableBody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="5">${selectedTeacher} has no classes assigned.</td></tr>`;
                return;
            }

            // Sort by day and time
            teacherClasses.sort((a, b) => {
                const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                const dayIndexA = days.indexOf(a.Day);
                const dayIndexB = days.indexOf(b.Day);
                if (dayIndexA !== dayIndexB) return dayIndexA - dayIndexB;
                return a.TimeSlot.localeCompare(b.TimeSlot); // Compare time strings
            });

            teacherClasses.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="table-cell">${cls.Day}</td>
                    <td class="table-cell">${cls.TimeSlot}</td>
                    <td class="table-cell">${cls.ClassName}</td>
                    <td class="table-cell">${cls.Subject}</td>
                    <td class="table-cell">${cls.ClassID}</td>
                `;
                individualTableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
